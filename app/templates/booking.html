<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>KMUTT Court Booking</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
    <link rel="manifest" href="/static/site.webmanifest" />
    <link rel="stylesheet" href="/static/css/shared.css" />
    <link rel="stylesheet" href="/static/css/booking.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>KMUTT Court Booking</h1>
        <p class="subtitle">Schedule your badminton court</p>
        <div class="nav-buttons">
          <a href="/bookings" class="nav-btn">All Bookings</a>
        </div>
      </header>

      <div class="message success" id="success"></div>
      <div class="message error" id="error"></div>

      <form id="bookingForm" novalidate>
        <div class="section">
          <div class="section-title">Booking Details</div>

          <div class="form-group">
            <label for="p1">Player 1</label>
            <input type="text" id="p1" name="p1" required />
            <span class="error-message" id="p1-error"></span>
          </div>

          <div class="form-group">
            <label for="p2">Player 2</label>
            <input type="text" id="p2" name="p2" required />
            <span class="error-message" id="p2-error"></span>
          </div>

          <div class="form-group">
            <label for="p3">Player 3</label>
            <input type="text" id="p3" name="p3" required />
            <span class="error-message" id="p3-error"></span>
          </div>

          <div class="form-group">
            <label for="court">Court</label>
            <select id="court" name="court" required>
              <option value="">Select a court</option>
            </select>
            <span class="error-message" id="court-error"></span>
          </div>

          <div class="form-group">
            <label for="submitTime">Auto-Submit Time</label>
            <input
              type="time"
              id="submitTime"
              name="submitTime"
              value="13:00"
              required
            />
            <small class="form-text-muted"
              >The time when the system will automatically submit your booking
              request.</small
            >
          </div>
        </div>

        <div class="section">
          <div class="section-title">Contact Information</div>
          <div class="form-group">
            <label for="confirmationEmail">Confirmation Email (Optional)</label>
            <input
              type="email"
              id="confirmationEmail"
              name="confirmationEmail"
              placeholder="your.email@example.com"
            />
            <small class="form-text-muted"
              >Note: If you provide a confirmation email, Player 1's name will
              be used as the booker. Otherwise, the admin's name and email will
              be used.</small
            >
          </div>

          <div id="extraFields" style="display: none">
            <div class="form-group">
              <label for="phone">Phone Number</label>
              <input
                type="tel"
                id="phone"
                name="phone"
                placeholder="08xxxxxxxx"
              />
              <span class="error-message" id="phone-error"></span>
            </div>

            <div class="form-group">
              <label for="student_id">Student ID</label>
              <input
                type="text"
                id="student_id"
                name="student_id"
                placeholder="6xxxxxxxxxx"
              />
              <span class="error-message" id="student_id-error"></span>
            </div>
          </div>
        </div>

        <button type="submit">Book Court</button>
        <div class="loading" id="loading">Scheduling...</div>
      </form>
    </div>

    <script>
      const form = document.getElementById("bookingForm");
      const successMsg = document.getElementById("success");
      const errorMsg = document.getElementById("error");
      const loading = document.getElementById("loading");
      const submitBtn = form.querySelector('button[type="submit"]');
      const courtSelect = document.getElementById("court");
      const confirmationEmailInput =
        document.getElementById("confirmationEmail");
      const extraFieldsDiv = document.getElementById("extraFields");

      confirmationEmailInput.addEventListener("input", function () {
        if (this.value.trim() !== "") {
          extraFieldsDiv.style.display = "block";
        } else {
          extraFieldsDiv.style.display = "none";
        }
      });

      async function loadCourts() {
        try {
          const response = await fetch("/api/courts");
          const data = await response.json();

          data.courts.forEach((court) => {
            const option = document.createElement("option");
            option.value = court.name;
            option.textContent = court.alias || court.name;
            courtSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Failed to load courts:", error);
        }
      }

      function showError(elementId, message) {
        const inputElement = document.getElementById(elementId);
        const errorMessageElement = document.getElementById(
          elementId + "-error",
        );
        inputElement.classList.add("is-invalid");
        errorMessageElement.textContent = message;
        errorMessageElement.style.display = "block";
      }

      function clearError(elementId) {
        const inputElement = document.getElementById(elementId);
        const errorMessageElement = document.getElementById(
          elementId + "-error",
        );
        inputElement.classList.remove("is-invalid");
        errorMessageElement.textContent = "";
        errorMessageElement.style.display = "none";
      }

      function validateForm(formData) {
        let isValid = true;

        // Validate Player 1
        if (!formData.p1.trim()) {
          showError("p1", "Player 1 name is required.");
          isValid = false;
        } else {
          clearError("p1");
        }

        // Validate Player 2
        if (!formData.p2.trim()) {
          showError("p2", "Player 2 name is required.");
          isValid = false;
        } else {
          clearError("p2");
        }

        // Validate Player 3
        if (!formData.p3.trim()) {
          showError("p3", "Player 3 name is required.");
          isValid = false;
        } else {
          clearError("p3");
        }

        // Validate Court
        if (!formData.court) {
          showError("court", "Please select a court.");
          isValid = false;
        } else {
          clearError("court");
        }

        // Validate Contact Info if Email is present
        if (formData.confirmation_email.trim()) {
          if (!formData.phone.trim()) {
            showError(
              "phone",
              "Phone number is required when email is provided.",
            );
            isValid = false;
          } else {
            clearError("phone");
          }

          if (!formData.student_id.trim()) {
            showError(
              "student_id",
              "Student ID is required when email is provided.",
            );
            isValid = false;
          } else {
            clearError("student_id");
          }
        } else {
          clearError("phone");
          clearError("student_id");
        }

        return isValid;
      }

      function loadSavedPlayers() {
        const savedData = localStorage.getItem("booking.psstee");
        if (savedData) {
          try {
            const players = JSON.parse(savedData);
            if (players.p1) document.getElementById("p1").value = players.p1;
            if (players.p2) document.getElementById("p2").value = players.p2;
            if (players.p3) document.getElementById("p3").value = players.p3;
            if (players.email) {
              document.getElementById("confirmationEmail").value =
                players.email;
              extraFieldsDiv.style.display = "block";
            }
            if (players.phone)
              document.getElementById("phone").value = players.phone;
            if (players.student_id)
              document.getElementById("student_id").value = players.student_id;
          } catch (e) {
            console.error("Error loading saved players:", e);
          }
        }
      }

      loadCourts();
      loadSavedPlayers();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        successMsg.style.display = "none";
        errorMsg.style.display = "none";

        const formData = {
          p1: document.getElementById("p1").value,
          p2: document.getElementById("p2").value,
          p3: document.getElementById("p3").value,
          court: document.getElementById("court").value,
          submit_time: document.getElementById("submitTime").value,
          confirmation_email:
            document.getElementById("confirmationEmail").value || "",
          phone: document.getElementById("phone").value || "",
          student_id: document.getElementById("student_id").value || "",
        };

        if (!validateForm(formData)) {
          // If validation fails, stop here
          return;
        }

        // Convert empty strings back to null for API if preferred,
        // though backend handles empty strings fine as "falsy"
        const apiData = {
          ...formData,
          confirmation_email: formData.confirmation_email || null,
          phone: formData.phone || null,
          student_id: formData.student_id || null,
        };

        loading.style.display = "block";
        submitBtn.disabled = true;

        try {
          const response = await fetch("/api/book", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(apiData),
          });

          const data = await response.json();

          if (response.ok) {
            localStorage.setItem(
              "booking.psstee",
              JSON.stringify({
                p1: formData.p1,
                p2: formData.p2,
                p3: formData.p3,
                email: formData.confirmation_email,
                phone: formData.phone,
                student_id: formData.student_id,
              }),
            );

            successMsg.textContent = `Booking confirmed for ${formData.p1}, ${formData.p2}, ${formData.p3} at ${formData.submit_time}`;
            successMsg.style.display = "block";
            form.reset();
            // Clear errors after successful submission and reset
            clearError("p1");
            clearError("p2");
            clearError("p3");
            clearError("court");
            clearError("phone");
            clearError("student_id");
            extraFieldsDiv.style.display = "none";
            document.getElementById("submitTime").value = "13:00";

            loadSavedPlayers();
          } else {
            errorMsg.textContent = `Error: ${data.detail || "Failed to schedule booking"}`;
            errorMsg.style.display = "block";
          }
        } catch (error) {
          errorMsg.textContent = `Error: ${error.message}`;
          errorMsg.style.display = "block";
        } finally {
          loading.style.display = "none";
          submitBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
