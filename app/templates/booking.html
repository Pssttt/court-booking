<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>KMUTT Court Booking</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
    <link rel="manifest" href="/static/site.webmanifest" />
    <link rel="stylesheet" href="/static/css/shared.css" />
    <link rel="stylesheet" href="/static/css/booking.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>KMUTT Court Booking</h1>
        <p class="subtitle">Schedule your badminton court</p>
        <div class="nav-buttons">
          <a href="/bookings" class="nav-btn">All Bookings</a>
        </div>
      </header>

      <div class="message success" id="success"></div>
      <div class="message error" id="error"></div>

      <form id="bookingForm">
        <div class="section">
          <div class="section-title">Players</div>

          <div class="form-group">
            <label for="p1">Player 1</label>
            <input type="text" id="p1" name="p1" required />
          </div>

          <div class="form-group">
            <label for="p2">Player 2</label>
            <input type="text" id="p2" name="p2" required />
          </div>

          <div class="form-group">
            <label for="p3">Player 3</label>
            <input type="text" id="p3" name="p3" required />
          </div>
        </div>

        <div class="section">
          <div class="form-group">
            <label for="court">Court</label>
            <select id="court" name="court" required>
              <option value="">Select a court</option>
            </select>
          </div>

          <div class="form-group">
            <label for="submitTime">Time</label>
            <input
              type="time"
              id="submitTime"
              name="submitTime"
              value="13:00"
              required
            />
          </div>

          <div class="form-group">
            <label for="confirmationEmail">Confirmation Email (Optional)</label>
            <input
              type="email"
              id="confirmationEmail"
              name="confirmationEmail"
              placeholder="your.email@example.com"
            />
            <small class="form-text-muted"
              >Note: If you provide a confirmation email, Player 1's name will
              be used as the booker. Otherwise, the admin's name and email will
              be used.</small
            >
          </div>
        </div>

        <button type="submit">Book Court</button>
        <div class="loading" id="loading">Scheduling...</div>
      </form>
    </div>

    <script>
      const form = document.getElementById("bookingForm");
      const successMsg = document.getElementById("success");
      const errorMsg = document.getElementById("error");
      const loading = document.getElementById("loading");
      const submitBtn = form.querySelector('button[type="submit"]');
      const courtSelect = document.getElementById("court");

      async function loadCourts() {
        try {
          const response = await fetch("/api/courts");
          const data = await response.json();

          const courtDisplayNames = {
            1: "Court 1, 1st Period",
            2: "Court 1, 2nd Period",
            3: "Court 2, 1st Period",
            4: "Court 2, 2nd Period",
            5: "Court 3, 1st Period",
            6: "Court 3, 2nd Period",
            7: "Court 4, 1st Period",
            8: "Court 4, 2nd Period",
          };

          data.courts.forEach((court) => {
            const option = document.createElement("option");
            option.value = court.name;
            option.textContent = courtDisplayNames[court.id] || court.name;
            courtSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Failed to load courts:", error);
        }
      }

      loadCourts();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        successMsg.style.display = "none";
        errorMsg.style.display = "none";
        loading.style.display = "block";
        submitBtn.disabled = true;

        const formData = {
          p1: document.getElementById("p1").value,
          p2: document.getElementById("p2").value,
          p3: document.getElementById("p3").value,
          court: document.getElementById("court").value,
          submit_time: document.getElementById("submitTime").value,
          confirmation_email:
            document.getElementById("confirmationEmail").value || null,
        };

        try {
          const response = await fetch("/api/book", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
          });

          const data = await response.json();

          if (response.ok) {
            successMsg.innerHTML = `Booking confirmed for ${formData.p1}, ${formData.p2}, ${formData.p3} at ${formData.submit_time}`;
            successMsg.style.display = "block";
            form.reset();
            document.getElementById("submitTime").value = "13:00";
          } else {
            errorMsg.innerHTML = `Error: ${data.detail || "Failed to schedule booking"}`;
            errorMsg.style.display = "block";
          }
        } catch (error) {
          errorMsg.innerHTML = `Error: ${error.message}`;
          errorMsg.style.display = "block";
        } finally {
          loading.style.display = "none";
          submitBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
