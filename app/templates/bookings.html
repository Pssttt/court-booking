<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>All Bookings</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
    <link rel="manifest" href="/static/site.webmanifest" />
    <link rel="stylesheet" href="/static/css/shared.css" />
    <link rel="stylesheet" href="/static/css/bookings.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>All Bookings</h1>
        <p class="subtitle">View and manage your scheduled bookings</p>
        <div class="nav-buttons">
          <button class="nav-btn active">All Bookings</button>
          <a href="/" class="nav-btn">New Booking</a>
        </div>
      </header>

      <div class="message info" id="info"></div>
      <div class="message success" id="success"></div>
      <div class="message error" id="error"></div>

      <div class="search-bar" style="margin-bottom: 20px;">
        <input 
            type="text" 
            id="searchInput" 
            placeholder="Search bookings by player name or ID..."
            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
            onkeyup="filterBookings()"
        >
      </div>

      <div class="loading" id="loading" style="display: none">
        Loading bookings...
      </div>
      <div class="bookings-list" id="bookingsList"></div>
    </div>

    <div class="modal" id="cancelModal">
      <div class="modal-content">
        <div class="modal-header">Cancel Booking?</div>
        <div class="modal-body">
          <p>Are you sure you want to cancel this booking?</p>
          <p style="margin-top: 12px; font-size: 12px; color: #999">
            <strong>Booking:</strong> <span id="cancelBookingInfo"></span>
          </p>
          <p style="margin-top: 8px; font-size: 12px">
            <label
              for="cancelPassword"
              style="display: block; margin-bottom: 6px"
              >Cancel Password / OTP:</label
            >
            <div style="display: flex; gap: 8px;">
                <input
                type="password"
                id="cancelPassword"
                class="password-input"
                placeholder="Enter password or OTP"
                style="margin-bottom: 0;"
                />
                <button 
                    type="button" 
                    id="requestCodeBtn"
                    onclick="requestCancelCode()"
                    style="padding: 0 12px; font-size: 12px; white-space: nowrap; cursor: pointer; background: #5865F2; color: white; border: none; border-radius: 2px;"
                    title="Get OTP via Discord"
                >
                    Get Code
                </button>
            </div>
            <div id="requestCodeMsg" style="font-size: 11px; margin-top: 4px; display: none;"></div>
          </p>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel" onclick="closeCancelModal()">
            Keep Booking
          </button>
          <button
            class="modal-btn confirm"
            onclick="confirmCancel()"
            id="confirmCancelBtn"
          >
            Cancel Booking
          </button>
        </div>
      </div>
    </div>

    <script>
      let allBookings = [];
      let cancelingBookingId = null;

      function isBookingPast(booking) {
        if (!booking.scheduled_datetime) return false;
        const now = new Date();
        const bookingTime = new Date(booking.scheduled_datetime);
        if (isNaN(bookingTime.getTime())) {
          console.warn("Invalid date format:", booking.scheduled_datetime);
          return false;
        }
        return bookingTime < now;
      }

      async function requestCancelCode() {
        if (!cancelingBookingId) return;
        
        const btn = document.getElementById("requestCodeBtn");
        const msg = document.getElementById("requestCodeMsg");
        
        btn.disabled = true;
        btn.style.opacity = "0.7";
        msg.style.display = "none";
        
        try {
            const response = await fetch("/api/request-cancel-code", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ booking_id: cancelingBookingId }),
            });
            
            const data = await response.json();
            
            msg.style.display = "block";
            if (response.ok) {
                msg.style.color = "#155724";
                msg.textContent = "Code sent to Discord channel!";
            } else {
                msg.style.color = "#c00";
                msg.textContent = data.detail || "Failed to send code";
            }
        } catch (error) {
            msg.style.display = "block";
            msg.style.color = "#c00";
            msg.textContent = "Error: " + error.message;
        } finally {
            btn.disabled = false;
            btn.style.opacity = "1";
        }
      }

      function escapeHtml(text) {
        if (!text) return "";
        return text
            .toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
      }

      let debounceTimer;
      function filterBookings() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const query = document.getElementById("searchInput").value.toLowerCase();
            const cards = document.querySelectorAll(".booking-card");
            let visibleCount = 0;

            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(query)) {
                    card.style.display = "block";
                    visibleCount++;
                } else {
                    card.style.display = "none";
                }
            });

            const infoMsg = document.getElementById("info");
            if (query.trim() !== "") {
                infoMsg.innerHTML = `Found ${visibleCount} booking${visibleCount !== 1 ? "s" : ""}`;
                infoMsg.style.display = "block";
            } else {
                infoMsg.innerHTML = `${allBookings.length} booking${allBookings.length !== 1 ? "s" : ""} scheduled`;
            }
        }, 300);
      }

      async function loadBookings() {
        const loading = document.getElementById("loading");
        const bookingsList = document.getElementById("bookingsList");
        const infoMsg = document.getElementById("info");

        if (allBookings.length === 0) {
            loading.style.display = "block";
        }
        
        const searchInput = document.getElementById("searchInput");
        const currentQuery = searchInput ? searchInput.value : "";

        bookingsList.innerHTML = "";
        infoMsg.style.display = "none";

        try {
          const response = await fetch("/api/bookings");
          const data = await response.json();
          allBookings = data.bookings || [];

          if (allBookings.length === 0) {
            bookingsList.innerHTML = `
                        <div class="empty-state">
                            <p>No bookings scheduled yet</p>
                            <p style="font-size: 12px; color: #999; margin-top: 8px;">Create your first booking to get started</p>
                        </div>
                    `;
            infoMsg.style.display = "none";
          } else {
            bookingsList.innerHTML = allBookings
              .reverse()
              .map((booking) => {
                const isPast = isBookingPast(booking);
                const statusText = isPast ? "Completed" : "Scheduled";
                const statusClass = isPast ? "submitted" : "";
                
                const p1 = escapeHtml(booking.p1);
                const p2 = escapeHtml(booking.p2);
                const p3 = escapeHtml(booking.p3);
                const email = escapeHtml(booking.confirmation_email || "None");

                return `
                            <div class="booking-card ${statusClass}">
                                <div class="booking-header">
                                    <div>
                                        <div class="booking-players">${p1}, ${p2}, ${p3}</div>
                                        <div class="booking-id">Booking #${booking.id}</div>
                                    </div>
                                    <span class="booking-status ${statusClass}">${statusText}</span>
                                </div>
                                <div class="booking-details">
                                    <div class="detail-item">
                                        <div class="detail-label">Court</div>
                                        <div class="detail-value">${booking.court}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Submit Time</div>
                                        <div class="detail-value">${booking.scheduled_datetime || booking.submit_time}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Created</div>
                                        <div class="detail-value">${new Date(booking.created_at).toLocaleDateString()}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Email</div>
                                        <div class="detail-value">${email}</div>
                                    </div>
                                </div>
                                ${
                                  !isPast
                                    ? `
                                    <div class="booking-actions">
                                        <button class="cancel-btn" onclick="openCancelModal(${booking.id}, '${p1.replace(/'/g, "\\'")}')">Cancel Booking</button>
                                    </div>
                                `
                                    : ""
                                }
                            </div>
                        `;
              })
              .join("");

            infoMsg.innerHTML = `${allBookings.length} booking${allBookings.length !== 1 ? "s" : ""} scheduled`;
            infoMsg.style.display = "block";
            
            if (currentQuery) {
                filterBookings();
            }
          }
        } catch (error) {
          console.error("Error loading bookings:", error);
          bookingsList.innerHTML =
            '<div class="empty-state"><p>Error loading bookings</p></div>';
        } finally {
          loading.style.display = "none";
        }
      }

      function openCancelModal(bookingId, playerName) {
        cancelingBookingId = bookingId;
        document.getElementById("cancelBookingInfo").textContent =
          `#${bookingId} - ${playerName}`;
        document.getElementById("cancelPassword").value = "";
        document.getElementById("requestCodeMsg").style.display = "none";
        document.getElementById("cancelModal").classList.add("active");
        document.getElementById("cancelPassword").focus();
      }

      function closeCancelModal() {
        document.getElementById("cancelModal").classList.remove("active");
        cancelingBookingId = null;
      }

      async function confirmCancel() {
        if (!cancelingBookingId) return;

        const password = document.getElementById("cancelPassword").value;
        if (!password) {
          alert("Please enter the cancel password");
          return;
        }

        const confirmBtn = document.getElementById("confirmCancelBtn");
        confirmBtn.disabled = true;
        confirmBtn.textContent = "Cancelling...";

        try {
          const response = await fetch("/api/cancel", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              booking_id: cancelingBookingId,
              password: password,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            document.getElementById("success").textContent =
              "Booking cancelled successfully";
            document.getElementById("success").style.display = "block";
            closeCancelModal();
            await loadBookings();
          } else {
            document.getElementById("error").textContent =
              data.detail || "Failed to cancel booking";
            document.getElementById("error").style.display = "block";
          }
        } catch (error) {
          document.getElementById("error").textContent =
            "Error: " + error.message;
          document.getElementById("error").style.display = "block";
        } finally {
          confirmBtn.disabled = false;
          confirmBtn.textContent = "Cancel Booking";
        }
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeCancelModal();
      });

      loadBookings();
      setInterval(loadBookings, 30000);
    </script>
  </body>
</html>
