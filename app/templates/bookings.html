<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>All Bookings</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
    <link rel="manifest" href="/static/site.webmanifest" />
    <link rel="stylesheet" href="/static/css/shared.css" />
    <link rel="stylesheet" href="/static/css/bookings.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>All Bookings</h1>
        <p class="subtitle">View and manage your scheduled bookings</p>
        <div class="nav-buttons">
          <button class="nav-btn active">All Bookings</button>
          <a href="/" class="nav-btn">New Booking</a>
        </div>
      </header>

      <div class="message info" id="info"></div>
      <div class="message success" id="success"></div>
      <div class="message error" id="error"></div>

      <div class="search-bar" style="margin-bottom: 20px">
        <input
          type="text"
          id="searchInput"
          placeholder="Search bookings by player name or ID..."
          style="
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
          "
          onkeyup="filterBookings()"
        />
      </div>

      <div class="loading" id="loading" style="display: none">
        Loading bookings...
      </div>

      <div class="bookings-container">
        <div class="table-wrapper">
          <table id="bookingsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Players</th>
                <th>Court</th>
                <th>Auto-Submit Time</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="bookingsList">
              <!-- Rows will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
      <div id="emptyStateContainer"></div>
    </div>

    <div class="modal" id="cancelModal">
      <div class="modal-content">
        <div class="modal-header">Cancel Booking?</div>
        <div class="modal-body">
          <p>Are you sure you want to cancel this booking?</p>
          <p style="margin-top: 12px; font-size: 12px; color: #999">
            <strong>Booking:</strong> <span id="cancelBookingInfo"></span>
          </p>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to cancel this booking?</p>

          <p style="margin-top: 12px; font-size: 12px; color: #999">
            <strong>Booking:</strong> <span id="cancelBookingInfo"></span>
          </p>

          <div style="margin-top: 8px; font-size: 12px">
            <label
              for="cancelPassword"
              style="display: block; margin-bottom: 6px"
              >Cancel Password / OTP:</label
            >
            <div style="display: flex; gap: 8px">
              <input
                type="password"
                id="cancelPassword"
                class="password-input"
                placeholder="Enter password or OTP"
                style="margin-bottom: 0"
              />
              <button
                type="button"
                id="requestCodeBtn"
                onclick="requestCancelCode()"
                style="
                  padding: 0 12px;
                  font-size: 12px;
                  white-space: nowrap;
                  cursor: pointer;
                  background: #5865f2;
                  color: white;
                  border: none;
                  border-radius: 2px;
                "
                title="Get OTP via Discord"
              >
                Get Code
              </button>
            </div>
            <div
              id="requestCodeMsg"
              style="font-size: 11px; margin-top: 4px; display: none"
            ></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel" onclick="closeCancelModal()">
            Keep Booking
          </button>
          <button
            class="modal-btn confirm"
            onclick="confirmCancel()"
            id="confirmCancelBtn"
          >
            Cancel Booking
          </button>
        </div>
      </div>
    </div>

    <script>
      let allBookings = [];
      let cancelingBookingId = null;
      let otpRateLimitSeconds = 60;
      let otpCountdownInterval = null;

      function isBookingPast(booking) {
        if (!booking || !booking.scheduled_datetime) {
          return false;
        }
        const scheduledDate = new Date(booking.scheduled_datetime);
        const now = new Date();
        return scheduledDate < now;
      }

      function startOtpCountdown() {
        const btn = document.getElementById("requestCodeBtn");
        const msg = document.getElementById("requestCodeMsg");
        let timeLeft = otpRateLimitSeconds;

        btn.disabled = true;
        msg.style.display = "block";
        msg.style.color = "#007bff";

        otpCountdownInterval = setInterval(() => {
          if (timeLeft <= 0) {
            clearInterval(otpCountdownInterval);
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.textContent = "Get Code";
            msg.style.display = "none";
            return;
          }
          btn.textContent = `Resend in ${timeLeft}s`;
          timeLeft--;
        }, 1000);
      }

      async function requestCancelCode() {
        if (!cancelingBookingId) return;

        const btn = document.getElementById("requestCodeBtn");
        const msg = document.getElementById("requestCodeMsg");

        if (btn.disabled && !otpCountdownInterval) return;

        clearInterval(otpCountdownInterval);
        btn.disabled = true;
        btn.style.opacity = "0.7";
        btn.textContent = "Sending...";
        msg.style.display = "none";

        try {
          const response = await fetch("/api/request-cancel-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ booking_id: cancelingBookingId }),
          });

          const data = await response.json();

          msg.style.display = "block";
          if (response.ok) {
            msg.style.color = "#155724";
            msg.textContent = "Code sent to Discord channel!";
            startOtpCountdown();
          } else {
            msg.style.color = "#c00";
            msg.textContent = data.detail || "Failed to send code";
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.textContent = "Get Code";
          }
        } catch (error) {
          msg.style.display = "block";
          msg.style.color = "#c00";
          msg.textContent = "Error: " + error.message;
          btn.disabled = false;
          btn.style.opacity = "1";
          btn.textContent = "Get Code";
        }
      }

      function escapeHtml(text) {
        if (!text) return "";
        return text
          .toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      let debounceTimer;
      function filterBookings() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          const query = document
            .getElementById("searchInput")
            .value.toLowerCase();
          const rows = document.querySelectorAll("#bookingsList tr");
          let visibleCount = 0;

          rows.forEach((row) => {
            const text = row.textContent.toLowerCase();
            if (text.includes(query)) {
              row.style.display = "";
              visibleCount++;
            } else {
              row.style.display = "none";
            }
          });

          const infoMsg = document.getElementById("info");
          if (query.trim() !== "") {
            infoMsg.innerHTML = `Found ${visibleCount} booking${visibleCount !== 1 ? "s" : ""}`;
            infoMsg.style.display = "block";
          } else {
            infoMsg.innerHTML = `${allBookings.length} booking${allBookings.length !== 1 ? "s" : ""} scheduled`;
          }
        }, 300);
      }

      async function loadBookings() {
        const loading = document.getElementById("loading");
        const bookingsList = document.getElementById("bookingsList");
        const emptyStateContainer = document.getElementById(
          "emptyStateContainer",
        );
        const tableContainer = document.querySelector(".bookings-container");
        const infoMsg = document.getElementById("info");

        if (allBookings.length === 0) {
          loading.style.display = "block";
        }

        const searchInput = document.getElementById("searchInput");
        const currentQuery = searchInput ? searchInput.value : "";

        bookingsList.innerHTML = "";
        emptyStateContainer.innerHTML = "";
        infoMsg.style.display = "none";

        try {
          const response = await fetch(
            `/api/bookings?t=${new Date().getTime()}`,
          );
          const data = await response.json();
          allBookings = data.bookings || [];

          if (allBookings.length === 0) {
            tableContainer.style.display = "none";
            emptyStateContainer.innerHTML = `
                <div class="empty-state">
                    <p>No bookings scheduled yet</p>
                    <p style="font-size: 12px; color: #999; margin-top: 8px;">Create your first booking to get started</p>
                </div>
            `;
            infoMsg.style.display = "none";
          } else {
            tableContainer.style.display = "block";
            bookingsList.innerHTML = allBookings
              .reverse()
              .map((booking) => {
                const isPast = isBookingPast(booking);
                const statusText = isPast ? "Completed" : "Scheduled";
                const statusClass = isPast ? "submitted" : "scheduled";

                const p1 = escapeHtml(booking.p1);
                const p2 = escapeHtml(booking.p2);
                const p3 = escapeHtml(booking.p3);

                const displayCourtName = booking.alias || booking.court;

                let displayTime = booking.submit_time;
                if (booking.scheduled_datetime) {
                  const dateObj = new Date(booking.scheduled_datetime);
                  if (!isNaN(dateObj.getTime())) {
                    displayTime = dateObj.toLocaleString([], {
                      year: "numeric",
                      month: "short",
                      day: "numeric",
                      hour: "2-digit",
                      minute: "2-digit",
                    });
                  }
                }

                return `
                    <tr>
                        <td data-label="ID" style="color: #718096; font-size: 12px;">#${booking.id}</td>
                        <td data-label="Players">
                            <div style="font-weight: 500;">${p1}</div>
                            <div style="font-size: 12px; color: #718096;">${p2}, ${p3}</div>
                        </td>
                        <td data-label="Court">${displayCourtName}</td>
                        <td data-label="Time">${displayTime}</td>
                        <td data-label="Status"><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td data-label="Action">
                            ${
                              !isPast
                                ? `
                                <button class="cancel-btn" onclick="openCancelModal(${booking.id}, '${p1.replace(/'/g, "\\'")}')">
                                    Cancel
                                </button>
                            `
                                : ""
                            }
                        </td>
                    </tr>
                `;
              })
              .join("");

            infoMsg.innerHTML = `${allBookings.length} booking${allBookings.length !== 1 ? "s" : ""} scheduled`;
            infoMsg.style.display = "block";

            if (currentQuery) {
              filterBookings();
            }
          }
        } catch (error) {
          console.error("Error loading bookings:", error);
          emptyStateContainer.innerHTML =
            '<div class="empty-state"><p>Error loading bookings</p></div>';
        } finally {
          loading.style.display = "none";
        }
      }

      function openCancelModal(bookingId, playerName) {
        cancelingBookingId = bookingId;
        document.getElementById("cancelBookingInfo").textContent =
          `#${bookingId} - ${playerName}`;
        document.getElementById("cancelPassword").value = "";
        document.getElementById("requestCodeMsg").style.display = "none";
        document.getElementById("cancelModal").classList.add("active");
        document.getElementById("cancelPassword").focus();
      }

      function closeCancelModal() {
        document.getElementById("cancelModal").classList.remove("active");
        cancelingBookingId = null;
      }

      async function confirmCancel() {
        if (!cancelingBookingId) return;

        const password = document.getElementById("cancelPassword").value;
        if (!password) {
          alert("Please enter the cancel password");
          return;
        }

        const confirmBtn = document.getElementById("confirmCancelBtn");
        confirmBtn.disabled = true;
        confirmBtn.textContent = "Cancelling...";

        try {
          const response = await fetch("/api/cancel", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              booking_id: cancelingBookingId,
              password: password,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            document.getElementById("success").textContent =
              "Booking cancelled successfully";
            document.getElementById("success").style.display = "block";
            closeCancelModal();
            await loadBookings();
          } else {
            document.getElementById("error").textContent =
              data.detail || "Failed to cancel booking";
            document.getElementById("error").style.display = "block";
          }
        } catch (error) {
          document.getElementById("error").textContent =
            "Error: " + error.message;
          document.getElementById("error").style.display = "block";
        } finally {
          confirmBtn.disabled = false;
          confirmBtn.textContent = "Cancel Booking";
        }
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeCancelModal();
      });

      document
        .getElementById("cancelPassword")
        .addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            confirmCancel();
          }
        });

      loadBookings();
      setInterval(loadBookings, 30000);
    </script>
  </body>
</html>
